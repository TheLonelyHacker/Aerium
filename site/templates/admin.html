{% extends "base.html" %}

{% block content %}
<section class="card">
  <h2>âš™ï¸ Admin Dashboard</h2>
  
  <!-- Statistics Section -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total Users -->
    <div style="
      background: linear-gradient(135deg, rgba(61, 217, 143, 0.2), rgba(77, 184, 255, 0.1));
      border: 1px solid rgba(61, 217, 143, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #3dd98f; margin-bottom: 5px;">{{ stats.total_users }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Utilisateurs Totaux</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">{{ stats.verified_users }} vÃ©rifiÃ©s</div>
    </div>

    <!-- Admin Count -->
    <div style="
      background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(255, 107, 107, 0.1));
      border: 1px solid rgba(239, 83, 80, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b6b; margin-bottom: 5px;">{{ stats.admin_count }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Administrateurs</div>
    </div>

    <!-- CO2 Readings -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4db8ff; margin-bottom: 5px;">{{ stats.total_readings }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Lectures COâ‚‚</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">Moyenne: {{ stats.avg_ppm }} ppm</div>
    </div>

    <!-- Recent Logins -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4ade80; margin-bottom: 5px;">{{ stats.recent_logins }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Connexions (24h)</div>
    </div>
  </div>

  <!-- User Management Section -->
  <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ‘¥ Gestion des Utilisateurs</h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
        <thead>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Nom d'utilisateur</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Email</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">VÃ©rifiÃ©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">RÃ´le</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">CrÃ©Ã©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0;">
            <td style="padding: 15px 10px;">
              <strong>{{ user.username }}</strong>
            </td>
            <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
              {{ user.email }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.email_verified %}
              <span style="color: #4ade80;">âœ“</span>
              {% else %}
              <span style="color: #ff6b6b;">âœ—</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.role == 'admin' %}
              <span style="background: rgba(239, 83, 80, 0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Admin</span>
              {% else %}
              <span style="background: rgba(61, 217, 143, 0.2); color: #4ade80; padding: 4px 8px; border-radius: 4px;">User</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center; font-size: 0.85rem; color: #9ca3af;">
              {{ user.created_at.split(' ')[0] if user.created_at else 'N/A' }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.id != session.get('user_id') %}
              <button 
                onclick="toggleRole({{ user.id }}, '{{ user.role }}')"
                style="
                  padding: 6px 12px;
                  background: {% if user.role == 'user' %}rgba(61, 217, 143, 0.2){% else %}rgba(77, 184, 255, 0.2){% endif %};
                  border: 1px solid {% if user.role == 'user' %}rgba(61, 217, 143, 0.3){% else %}rgba(77, 184, 255, 0.3){% endif %};
                  color: {% if user.role == 'user' %}#4ade80{% else %}#4db8ff{% endif %};
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  font-weight: 600;
                  transition: all 0.2s ease;
                "
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
              >
                {% if user.role == 'user' %}Make Admin{% else %}Remove Admin{% endif %}
              </button>
              {% else %}
              <span style="color: #9ca3af; font-size: 0.85rem;">Vous</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Back Button -->
  <div style="margin-top: 30px;">
    <a href="{{ url_for('index') }}" style="
      padding: 10px 20px;
      background: rgba(77, 184, 255, 0.2);
      border: 1px solid rgba(77, 184, 255, 0.3);
      border-radius: 6px;
      color: #4db8ff;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-block;
    "
    onmouseover="this.style.background='rgba(77, 184, 255, 0.3)'"
    onmouseout="this.style.background='rgba(77, 184, 255, 0.2)'"
    >
      â† Retour au tableau de bord
    </a>
  </div>
</section>

<script>
function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  const action = newRole === 'admin' ? 'Make Admin' : 'Remove Admin';
  
  if (!confirm(`Are you sure you want to ${action} this user?`)) {
    return;
  }
  
  fetch(`/admin/user/${userId}/role/${newRole}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to show updated roles
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to update role'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update user role');
  });
}
</script>

{% endblock %}
