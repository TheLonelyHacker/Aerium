{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-tools.css') }}">

<div class="admin-container">
    <div class="admin-header">
        <h1>âš™ï¸ Administration</h1>
        <p>GÃ©rez les utilisateurs, surveillez le systÃ¨me et effectuez la maintenance</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchAdminTab('overview')">ğŸ“Š Vue d'ensemble</button>
        <button class="tab-btn" onclick="switchAdminTab('users')">ğŸ‘¥ Utilisateurs</button>
        <button class="tab-btn" onclick="switchAdminTab('audit')">ğŸ“‹ Audit</button>
        <button class="tab-btn" onclick="switchAdminTab('sessions')">ğŸ” Sessions</button>
        <button class="tab-btn" onclick="switchAdminTab('system')">ğŸ–¥ï¸ SystÃ¨me</button>
        <button class="tab-btn" onclick="switchAdminTab('backups')">ğŸ’¾ Sauvegardes</button>
        <button class="tab-btn" onclick="switchAdminTab('maintenance')">ğŸ”§ Maintenance</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">Utilisateurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¡</div>
                <div class="stat-value" id="total-sensors">0</div>
                <div class="stat-label">Capteurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-value" id="total-readings">0</div>
                <div class="stat-label">Lectures</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-value" id="active-alerts">0</div>
                <div class="stat-label">Alertes Actives</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <section class="card">
                <h3>ActivitÃ© RÃ©cente</h3>
                <div id="recent-activity"></div>
            </section>
            
            <section class="card">
                <h3>Ã‰tat du SystÃ¨me</h3>
                <div class="system-status" id="system-status"></div>
            </section>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <section class="card">
            <div class="section-header">
                <h2>ğŸ‘¥ Gestion des Utilisateurs</h2>
                <button class="btn btn-primary" onclick="openCreateUserModal()">â• CrÃ©er Utilisateur</button>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>RÃ´le</th>
                        <th>CrÃ©Ã© le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr><td colspan="6">Chargement...</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <!-- Audit Tab -->
    <div id="audit-tab" class="tab-content">
        <section class="card">
            <div class="section-header">
                <h2>ğŸ“‹ Journaux d'Audit</h2>
                <button class="btn btn-secondary" onclick="loadAuditLogs()">ğŸ”„ Actualiser</button>
            </div>

            <div class="filters">
                <input type="number" id="audit-days" placeholder="Jours" value="30">
                <select id="audit-action">
                    <option value="">Toutes les actions</option>
                    <option value="login">Connexion</option>
                    <option value="logout">DÃ©connexion</option>
                    <option value="create">CrÃ©ation</option>
                    <option value="update">Modification</option>
                    <option value="delete">Suppression</option>
                </select>
                <button class="btn btn-secondary" onclick="loadAuditLogs()">Filtrer</button>
            </div>

            <div class="audit-summary">
                <div class="stat-box">
                    <span class="stat-label">Actions Totales</span>
                    <span class="stat-value" id="audit-total">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Haute SÃ©vÃ©ritÃ©</span>
                    <span class="stat-value" id="audit-high">0</span>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Date/Heure</th>
                        <th>Utilisateur</th>
                        <th>Action</th>
                        <th>EntitÃ©</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody id="audit-table-body">
                    <tr><td colspan="5">Chargement...</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <!-- Sessions Tab -->
    <div id="sessions-tab" class="tab-content">
        <section class="card">
            <div class="section-header">
                <h2>ğŸ” Sessions Actives</h2>
                <button class="btn btn-secondary" onclick="loadActiveSessions()">ğŸ”„ Actualiser</button>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>IP</th>
                        <th>DerniÃ¨re ActivitÃ©</th>
                        <th>DurÃ©e</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-table-body">
                    <tr><td colspan="5">Chargement...</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <!-- System Tab -->
    <div id="system-tab" class="tab-content">
        <section class="card">
            <h2>ğŸ–¥ï¸ SantÃ© du SystÃ¨me</h2>
            
            <div class="system-metrics" id="system-metrics">
                <div class="metric-row">
                    <span>CPU:</span>
                    <div class="metric-bar"><div class="metric-fill" style="width: 0%"></div></div>
                    <span id="cpu-percent">0%</span>
                </div>
                <div class="metric-row">
                    <span>MÃ©moire:</span>
                    <div class="metric-bar"><div class="metric-fill" style="width: 0%"></div></div>
                    <span id="memory-percent">0%</span>
                </div>
                <div class="metric-row">
                    <span>Disque:</span>
                    <div class="metric-bar"><div class="metric-fill" style="width: 0%"></div></div>
                    <span id="disk-percent">0%</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="loadSystemHealth()">Charger les MÃ©triques</button>
        </section>

        <section class="card">
            <h2>ğŸ’¾ Base de DonnÃ©es</h2>
            <div id="db-info">
                <p>Taille: <strong id="db-size">--</strong></p>
                <p>Tables: <strong id="db-tables">--</strong></p>
                <p>DerniÃ¨re sauvegarde: <strong id="db-last-backup">--</strong></p>
            </div>
        </section>
    </div>

    <!-- Backups Tab -->
    <div id="backups-tab" class="tab-content">
        <section class="card">
            <div class="section-header">
                <h2>ğŸ’¾ Sauvegardes</h2>
                <button class="btn btn-primary" onclick="createBackup()">CrÃ©er une Sauvegarde</button>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Date</th>
                        <th>Taille</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="backups-table-body">
                    <tr><td colspan="4">Chargement...</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <!-- Maintenance Tab -->
    <div id="maintenance-tab" class="tab-content">
        <section class="card">
            <h2>ğŸ”§ Maintenance</h2>
            
            <div class="maintenance-actions">
                <button class="btn btn-warning" onclick="cleanupOldData()">ğŸ—‘ï¸ Nettoyer les Vieilles DonnÃ©es</button>
                <button class="btn btn-warning" onclick="optimizeDatabase()">âš¡ Optimiser la Base de DonnÃ©es</button>
                <button class="btn btn-warning" onclick="clearCache()">ğŸ”„ Vider le Cache</button>
                <button class="btn btn-danger" onclick="restartServer()">ğŸ”´ RedÃ©marrer le Serveur</button>
            </div>

            <div id="maintenance-log" class="maintenance-log"></div>
        </section>

        <section class="card">
            <h2>ğŸ—‘ï¸ RÃ©tention des DonnÃ©es</h2>
            
            <div class="form-group">
                <label>Jours de RÃ©tention</label>
                <input type="number" id="retention-days" value="90" min="1">
            </div>

            <button class="btn btn-primary" onclick="updateRetention()">Mettre Ã  Jour</button>
        </section>
    </div>
</div>

<script>
function switchAdminTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.admin-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
    
    // Load data for tab
    if (tabName === 'overview') loadOverview();
    else if (tabName === 'users') loadUsers();
    else if (tabName === 'audit') loadAuditLogs();
    else if (tabName === 'sessions') loadActiveSessions();
    else if (tabName === 'system') loadSystemHealth();
    else if (tabName === 'backups') loadBackups();
}

function loadOverview() {
    fetch('/api/admin/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-users').textContent = data.users || 0;
                document.getElementById('total-sensors').textContent = data.sensors || 0;
                document.getElementById('total-readings').textContent = data.readings || 0;
                document.getElementById('active-alerts').textContent = data.alerts || 0;
            }
        });
}

function loadUsers() {
    fetch('/api/admin/users')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('users-table-body');
            if (data.success && data.users.length > 0) {
                tbody.innerHTML = data.users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${u.role}">${u.role}</span></td>
                        <td>${u.created_at}</td>
                        <td>
                            <button class="btn-sm" onclick="editUser(${u.id})">Ã‰diter</button>
                            <button class="btn-sm btn-danger" onclick="deleteUser(${u.id})">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6">Aucun utilisateur trouvÃ©</td></tr>';
            }
        });
}

function loadAuditLogs() {
    const days = document.getElementById('audit-days').value;
    const action = document.getElementById('audit-action').value;
    
    fetch(`/api/admin/audit?days=${days}&action=${action}`)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('audit-table-body');
            if (data.success && data.logs.length > 0) {
                tbody.innerHTML = data.logs.map(log => `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td>${log.username}</td>
                        <td>${log.action}</td>
                        <td>${log.entity_type} #${log.entity_id}</td>
                        <td>${log.ip_address}</td>
                    </tr>
                `).join('');
                
                document.getElementById('audit-total').textContent = data.total || 0;
                document.getElementById('audit-high').textContent = data.high_severity || 0;
            } else {
                tbody.innerHTML = '<tr><td colspan="5">Aucun journal d\'audit</td></tr>';
            }
        });
}

function loadActiveSessions() {
    fetch('/api/admin/sessions')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('sessions-table-body');
            if (data.success && data.sessions.length > 0) {
                tbody.innerHTML = data.sessions.map(s => `
                    <tr>
                        <td>${s.username}</td>
                        <td>${s.ip}</td>
                        <td>${s.last_activity}</td>
                        <td>${s.duration}</td>
                        <td>
                            <button class="btn-sm btn-danger" onclick="terminateSession('${s.session_id}')">Terminer</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5">Aucune session active</td></tr>';
            }
        });
}

function loadSystemHealth() {
    fetch('/api/admin/system-health')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cpu-percent').textContent = data.cpu + '%';
                document.getElementById('memory-percent').textContent = data.memory + '%';
                document.getElementById('disk-percent').textContent = data.disk + '%';
            }
        });
}

function loadBackups() {
    fetch('/api/admin/backups')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('backups-table-body');
            if (data.success && data.backups.length > 0) {
                tbody.innerHTML = data.backups.map(b => `
                    <tr>
                        <td>${b.name}</td>
                        <td>${b.date}</td>
                        <td>${b.size}</td>
                        <td>
                            <button class="btn-sm" onclick="restoreBackup('${b.name}')">Restaurer</button>
                            <button class="btn-sm btn-danger" onclick="deleteBackup('${b.name}')">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4">Aucune sauvegarde</td></tr>';
            }
        });
}

function createBackup() {
    if (confirm('CrÃ©er une nouvelle sauvegarde ?')) {
        fetch('/api/admin/backups', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.success ? 'âœ… Sauvegarde crÃ©Ã©e' : 'âŒ Erreur: ' + data.error);
                loadBackups();
            });
    }
}

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadOverview();
});
</script>

<style>
.admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    flex-wrap: wrap;
}

.tab-btn {
    padding: 12px 20px;
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s;
    position: relative;
}

.tab-btn.active {
    color: var(--accent);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
}

.stat-label {
    color: var(--muted);
    font-size: 0.9rem;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th,
.admin-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.admin-table th {
    background: rgba(255, 255, 255, 0.05);
    font-weight: 600;
}

.filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filters input,
.filters select {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--text);
}

.maintenance-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}
</style>

{% endblock %}
