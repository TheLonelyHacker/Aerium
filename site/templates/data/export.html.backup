{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/export-manager.css') }}">

<div class="container">
    <div class="export-header">
        <h1>üìä Gestion des Donn√©es et Export</h1>
        <p>Exportez vos donn√©es, g√©n√©rez des rapports et recevez des recommandations de sant√©</p>
    </div>

    <div class="data-tabs">
        <button class="tab-btn active" onclick="switchDataTab('export')">üì• Export</button>
        <button class="tab-btn" onclick="switchDataTab('reports')">üìã Rapports</button>
        <button class="tab-btn" onclick="switchDataTab('health')">‚ù§Ô∏è Sant√©</button>
    </div>

    <!-- Tab: Export Manager -->
    <div id="export-tab" class="tab-content active">
        <div class="export-grid">
            <!-- Export Imm√©diat -->
            <section class="export-card">
                <h2>üì• Export Imm√©diat</h2>
                <div class="export-form">
                    <div class="form-group">
                        <label>Capteur</label>
                        <select id="sensorSelect">
                            <option value="">S√©lectionnez un capteur...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>P√©riode</label>
                        <select id="periodSelect">
                            <option value="7">7 derniers jours</option>
                            <option value="30">30 derniers jours</option>
                            <option value="90">90 derniers jours</option>
                            <option value="365">1 ann√©e</option>
                        </select>
                    </div>

                    <div class="export-formats">
                        <button class="btn-format csv" onclick="exportData('csv')">
                            <span>üìÑ</span> CSV
                        </button>
                        <button class="btn-format excel" onclick="exportData('excel')">
                            <span>üìä</span> Excel
                        </button>
                        <button class="btn-format pdf" onclick="exportData('pdf')">
                            <span>üìã</span> PDF
                        </button>
                    </div>
                </div>
            </section>

            <!-- Export Programm√© -->
            <section class="export-card">
                <h2>‚è∞ Export Programm√©</h2>
                <div class="scheduled-form">
                    <div class="form-group">
                        <label>Capteur</label>
                        <select id="scheduledSensor">
                            <option value="">S√©lectionnez un capteur...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Format</label>
                        <select id="scheduledFormat">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Fr√©quence</label>
                        <select id="scheduledFrequency">
                            <option value="daily">Quotidien</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuel</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="scheduledEmail" placeholder="votre@email.com">
                    </div>

                    <button class="btn-primary" onclick="scheduleExport()">Programmer</button>
                </div>

                <div id="scheduled-list" class="scheduled-list">
                    <h3>Exports Programm√©s</h3>
                    <div id="scheduled-exports"></div>
                </div>
            </section>

            <!-- Historique d'Export -->
            <section class="export-card">
                <h2>üìú Historique d'Export</h2>
                <div class="export-history" id="exportHistory">
                    <p>Chargement...</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Tab: Reports -->
    <div id="reports-tab" class="tab-content">
        <section class="card">
            <h2>üìã G√©n√©ration de Rapports Quotidiens</h2>
            <p>G√©n√©rez des rapports PDF d√©taill√©s de la qualit√© de l'air</p>

            <div class="form-group">
                <label>Capteur</label>
                <select id="reportSensor">
                    <option value="">S√©lectionnez un capteur...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date</label>
                <input type="date" id="reportDate">
            </div>

            <button class="btn-primary" onclick="generateDailyReport()">G√©n√©rer le Rapport</button>

            <div id="report-status" class="data-container" style="display: none; margin-top: 20px;"></div>
        </section>

        <section class="card">
            <h2>üìä M√©triques du Rapport</h2>
            <div class="metrics-grid" id="reportMetrics">
                <div class="metric-card">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Moyenne (ppm)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Maximum (ppm)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Minimum (ppm)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Temps D√©grad√© (min)</div>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>üìë Rapports R√©cents</h2>
            <div id="recent-reports" class="reports-list">
                <p>Aucun rapport disponible</p>
            </div>
        </section>
    </div>

    <!-- Tab: Health Recommendations -->
    <div id="health-tab" class="tab-content">
        <section class="feature-section">
            <h2>üéØ Votre Score de Sant√©</h2>
            <p>√âvaluation g√©n√©rale de votre qualit√© de l'air et impact sur la sant√©</p>
            
            <div class="health-score-container">
                <div class="score-circle" id="score-circle">
                    <div class="score-value">--</div>
                    <div class="score-label">Score de Sant√©</div>
                </div>
                <div class="score-details">
                    <div class="detail-item">
                        <span class="detail-label">Niveau de CO‚ÇÇ</span>
                        <span class="detail-value" id="co2-level">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Statut</span>
                        <span class="detail-value" id="health-status">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Derni√®re Mise √† Jour</span>
                        <span class="detail-value" id="last-updated">√Ä l'instant</span>
                    </div>
                </div>
            </div>

            <button onclick="loadHealthScore()" class="btn btn-primary" style="margin-top: 20px;">Actualiser le Score</button>
        </section>

        <section class="feature-section">
            <h2>üí° Recommandations Personnalis√©es</h2>
            <p>Actions que vous pouvez prendre pour am√©liorer votre qualit√© de l'air</p>
            
            <div class="control-group">
                <button onclick="loadRecommendations()" class="btn btn-primary">Charger les Recommandations</button>
            </div>

            <div id="recommendations-container" class="data-container">
                <div class="loading">Chargement des recommandations...</div>
            </div>
        </section>

        <section class="feature-section">
            <h2>üìö Conseils de Sant√©</h2>
            <div class="tips-grid">
                <div class="tip-card">
                    <h3>üå± Niveaux de CO‚ÇÇ Sains</h3>
                    <p><strong>Air ext√©rieur:</strong> ~400 ppm</p>
                    <p><strong>Int√©rieur id√©al:</strong> 400-600 ppm</p>
                    <p><strong>Acceptable:</strong> 600-1000 ppm</p>
                    <p><strong>Mauvais:</strong> 1000+ ppm</p>
                </div>

                <div class="tip-card">
                    <h3>üò¥ Effets du CO‚ÇÇ √âlev√©</h3>
                    <p>Un CO‚ÇÇ int√©rieur √©lev√© peut causer:</p>
                    <ul>
                        <li>Fonctions cognitives r√©duites</li>
                        <li>Fatigue et somnolence</li>
                        <li>Maux de t√™te</li>
                        <li>Difficult√©s √† se concentrer</li>
                    </ul>
                </div>

                <div class="tip-card">
                    <h3>ü™ü Am√©liorer la Qualit√© de l'Air</h3>
                    <ul>
                        <li>Ouvrir les fen√™tres r√©guli√®rement</li>
                        <li>Utiliser des ventilateurs</li>
                        <li>Ajouter des plantes d'int√©rieur</li>
                        <li>Utiliser un purificateur d'air</li>
                    </ul>
                </div>

                <div class="tip-card">
                    <h3>‚è∞ Quand Agir</h3>
                    <p><strong>800-1000 ppm:</strong> Ouvrir les fen√™tres</p>
                    <p><strong>1000-1500 ppm:</strong> Ventilation imm√©diate</p>
                    <p><strong>1500+ ppm:</strong> √âvacuer si possible</p>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
function switchDataTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.data-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`[onclick="switchDataTab('${tabName}')"]`).classList.add('active');
    
    // Load data for tab
    if (tabName === 'export') loadSensors();
    else if (tabName === 'reports') loadReportSensors();
    else if (tabName === 'health') loadHealthScore();
}

// Export functions
function loadSensors() {
    fetch('/api/sensors')
        .then(r => r.json())
        .then(data => {
            const selects = [document.getElementById('sensorSelect'), document.getElementById('scheduledSensor')];
            selects.forEach(select => {
                if (select && data.sensors) {
                    select.innerHTML = '<option value="">Tous les capteurs</option>' +
                        data.sensors.map(s => `<option value="${s.id}">${s.name} (ID: ${s.id})</option>`).join('');
                }
            });
        });
}

function exportData(format) {
    const sensorId = document.getElementById('sensorSelect').value;
    const days = document.getElementById('periodSelect').value;
    
    const url = `/api/export/${format}?days=${days}` + (sensorId ? `&sensor_id=${sensorId}` : '');
    window.location.href = url;
}

function scheduleExport() {
    const data = {
        sensor_id: document.getElementById('scheduledSensor').value,
        format: document.getElementById('scheduledFormat').value,
        frequency: document.getElementById('scheduledFrequency').value,
        email: document.getElementById('scheduledEmail').value
    };
    
    fetch('/api/export/schedule', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        alert(data.success ? '‚úÖ Export programm√© avec succ√®s' : '‚ùå Erreur: ' + data.error);
    });
}

// Reports functions
function loadReportSensors() {
    fetch('/api/sensors')
        .then(r => r.json())
        .then(data => {
            const select = document.getElementById('reportSensor');
            if (select && data.sensors) {
                select.innerHTML = '<option value="">S√©lectionnez un capteur...</option>' +
                    data.sensors.map(s => `<option value="${s.id}">${s.name} (ID: ${s.id})</option>`).join('');
            }
        });
}

function generateDailyReport() {
    const sensorId = document.getElementById('reportSensor').value;
    const date = document.getElementById('reportDate').value;
    
    if (!sensorId || !date) {
        alert('Veuillez s√©lectionner un capteur et une date');
        return;
    }
    
    const status = document.getElementById('report-status');
    status.style.display = 'block';
    status.innerHTML = '<div class="loading">G√©n√©ration du rapport...</div>';
    
    fetch(`/report/daily/${sensorId}?date=${date}`)
        .then(r => r.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport_${date}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            status.innerHTML = '<div class="success">‚úÖ Rapport g√©n√©r√© avec succ√®s</div>';
        })
        .catch(() => {
            status.innerHTML = '<div class="error">‚ùå Erreur lors de la g√©n√©ration</div>';
        });
}

// Health functions
function loadHealthScore() {
    fetch('/api/health/score')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#score-circle .score-value').textContent = data.score;
                document.getElementById('co2-level').textContent = data.co2_level + ' ppm';
                document.getElementById('health-status').textContent = data.status;
                
                const circle = document.getElementById('score-circle');
                circle.className = 'score-circle';
                if (data.score >= 80) circle.classList.add('good');
                else if (data.score >= 60) circle.classList.add('medium');
                else circle.classList.add('bad');
            }
        });
}

function loadRecommendations() {
    const container = document.getElementById('recommendations-container');
    container.innerHTML = '<div class="loading">Chargement...</div>';
    
    fetch('/api/health/recommendations')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.recommendations) {
                container.innerHTML = data.recommendations.map(rec => `
                    <div class="recommendation-card">
                        <h3>${rec.priority === 'high' ? 'üî¥' : rec.priority === 'medium' ? 'üü°' : 'üü¢'} ${rec.title}</h3>
                        <p>${rec.description}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">Aucune recommandation disponible</p>';
            }
        });
}

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadSensors();
});
</script>

<style>
.data-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.tab-btn {
    padding: 12px 24px;
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    position: relative;
}

.tab-btn.active {
    color: var(--accent);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.health-score-container {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 30px;
    align-items: center;
}

.score-circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 8px solid var(--muted);
}

.score-circle.good {
    border-color: var(--good);
}

.score-circle.medium {
    border-color: #f59e0b;
}

.score-circle.bad {
    border-color: var(--bad);
}

.score-value {
    font-size: 3rem;
    font-weight: bold;
}

.score-label {
    font-size: 0.9rem;
    color: var(--muted);
}

.score-details {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
}

.detail-label {
    color: var(--muted);
}

.detail-value {
    font-weight: 600;
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.tip-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
}

.tip-card h3 {
    margin-bottom: 10px;
    color: var(--accent);
}

.tip-card ul {
    margin-left: 20px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.metric-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
}

.metric-label {
    color: var(--muted);
    font-size: 0.85rem;
}
</style>

{% endblock %}
