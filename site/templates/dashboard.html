{% extends "base.html" %}

{% block content %}

<!-- Show Admin Dashboard if user is admin -->
{% if is_admin %}

<section class="card">
  <h2>âš™ï¸ Admin Dashboard</h2>
  
  <!-- Statistics Section -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total Users -->
    <div style="
      background: linear-gradient(135deg, rgba(61, 217, 143, 0.2), rgba(77, 184, 255, 0.1));
      border: 1px solid rgba(61, 217, 143, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #3dd98f; margin-bottom: 5px;">{{ admin_stats.total_users }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Utilisateurs Totaux</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">{{ admin_stats.verified_users }} vÃ©rifiÃ©s</div>
    </div>

    <!-- Admin Count -->
    <div style="
      background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(255, 107, 107, 0.1));
      border: 1px solid rgba(239, 83, 80, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b6b; margin-bottom: 5px;">{{ admin_stats.admin_count }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Administrateurs</div>
    </div>

    <!-- CO2 Readings -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4db8ff; margin-bottom: 5px;">{{ admin_stats.total_readings }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Lectures COâ‚‚</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">Moyenne: {{ admin_stats.avg_ppm }} ppm</div>
    </div>

    <!-- Recent Logins -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4ade80; margin-bottom: 5px;">{{ admin_stats.recent_logins }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Connexions (24h)</div>
    </div>
  </div>

  <!-- User Management Section -->
  <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ‘¥ Gestion des Utilisateurs</h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
        <thead>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Nom d'utilisateur</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Email</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">VÃ©rifiÃ©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">RÃ´le</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">CrÃ©Ã©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in admin_users %}
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0;">
            <td style="padding: 15px 10px;">
              <strong>{{ user.username }}</strong>
            </td>
            <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
              {{ user.email }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.email_verified %}
              <span style="color: #4ade80;">âœ“</span>
              {% else %}
              <span style="color: #ff6b6b;">âœ—</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.role == 'admin' %}
              <span style="background: rgba(239, 83, 80, 0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Admin</span>
              {% else %}
              <span style="background: rgba(61, 217, 143, 0.2); color: #4ade80; padding: 4px 8px; border-radius: 4px;">User</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center; font-size: 0.85rem; color: #9ca3af;">
              {{ user.created_at.split(' ')[0] if user.created_at else 'N/A' }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.id != session.get('user_id') %}
              <button 
                onclick="toggleRole({{ user.id }}, '{{ user.role }}')"
                style="
                  padding: 6px 12px;
                  background: {% if user.role == 'user' %}rgba(61, 217, 143, 0.2){% else %}rgba(77, 184, 255, 0.2){% endif %};
                  border: 1px solid {% if user.role == 'user' %}rgba(61, 217, 143, 0.3){% else %}rgba(77, 184, 255, 0.3){% endif %};
                  color: {% if user.role == 'user' %}#4ade80{% else %}#4db8ff{% endif %};
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  font-weight: 600;
                  transition: all 0.2s ease;
                "
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
              >
                {% if user.role == 'user' %}Make Admin{% else %}Remove Admin{% endif %}
              </button>
              {% else %}
              <span style="color: #9ca3af; font-size: 0.85rem;">Vous</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  const action = newRole === 'admin' ? 'Make Admin' : 'Remove Admin';
  
  if (!confirm(`Are you sure you want to ${action} this user?`)) {
    return;
  }
  
  fetch(`/admin/user/${userId}/role/${newRole}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to show updated roles
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to update role'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update user role');
  });
}
</script>

<!-- Regular User Dashboard -->
{% else %}

<!-- ================= HERO ================= -->
<section class="hero">
  <div class="hero-content">
    <h1>Aerium</h1>
    <p class="hero-sub">
      Surveillance intelligente de la qualitÃ© de l'air en temps rÃ©el
    </p>

    <div class="system-pill paused">
      <span class="dot"></span>
      Analyse en pause
    </div>

    <div class="hero-actions">
      <a href="/live" class="link primary">ğŸ“Š Voir le live</a>
      <button id="export-day-csv" class="link">ğŸ“¥ DonnÃ©es en CSV</button>
      <button id="export-day-pdf" class="link">ğŸ“„ Rapport PDF</button>
    </div>
  </div>
</section>

<!-- ================= DAILY STATS ================= -->
<section class="card">
  <h2>Aujourd'hui en chiffres</h2>

  <div class="overview-grid">
    <div class="overview-widget highlight">
      <span class="label">Moyenne COâ‚‚</span>
      <span class="value" id="avg-ppm">â€”</span>
    </div>

    <div class="overview-widget">
      <span class="label">Pic maximum</span>
      <span class="value" id="max-ppm">â€”</span>
    </div>

    <div class="overview-widget">
      <span class="label">Temps en air dÃ©gradÃ©</span>
      <span class="value" id="bad-time">â€”</span>
    </div>
  </div>
</section>

<!-- ================= SYSTEM STATUS ================= -->
<section class="card">
  <h2>Ã‰tat du systÃ¨me</h2>

  <div class="system-status-row">
    <div class="system-status">
      <label>Statut du capteur</label>
      <p id="sensor-status">ğŸ”´ En attente de donnÃ©es</p>
    </div>

    <div class="system-status">
      <label>DerniÃ¨re lecture</label>
      <p id="last-reading">â€”</p>
    </div>

    <div class="system-status">
      <label>Seuil d'alerte</label>
      <button id="threshold-btn" class="link">800 ppm</button>
    </div>
  </div>
</section>

<!-- ================= CHART ================= -->
<section class="card">
  <h2>Historique du jour</h2>
  <canvas id="chart-daily"></canvas>
</section>

<script src="/static/js/overview.js"></script>

{% endif %}

{% endblock %}
