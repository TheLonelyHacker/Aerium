{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/collaboration.css') }}">

<div class="container">
    <div class="collab-header">
        <h1>üë• Collaboration d'√âquipe</h1>
        <p>Partagez les donn√©es, cr√©ez des alertes et collaborez en temps r√©el</p>
    </div>

    <div class="collaboration-tabs">
        <button class="tab-btn active" onclick="switchCollabTab('shares')">Partages</button>
        <button class="tab-btn" onclick="switchCollabTab('alerts')">Alertes Partag√©es</button>
        <button class="tab-btn" onclick="switchCollabTab('comments')">Commentaires</button>
        <button class="tab-btn" onclick="switchCollabTab('activity')">Activit√© d'√âquipe</button>
        <button class="tab-btn" onclick="switchCollabTab('teams')">√âquipes</button>
    </div>

    <!-- Tab: Shares -->
    <div id="shares-tab" class="tab-content active">
        <section class="card">
            <div class="section-header">
                <h2>üìä Tableaux de Bord Partag√©s</h2>
                <button class="btn btn-primary" onclick="openShareModal()">
                    ‚ûï Partager un Capteur
                </button>
            </div>

            <div class="shares-grid" id="sharesGrid">
                <p class="loading">Chargement des partages...</p>
            </div>
        </section>

        <section class="card">
            <h2>üîó Cr√©er un Lien de Partage</h2>
            <p>Cr√©ez un lien s√©curis√© pour partager vos donn√©es avec des coll√®gues</p>
            
            <div class="control-group">
                <label for="share-sensor-id">ID du Capteur</label>
                <input type="number" id="share-sensor-id" placeholder="1">
            </div>

            <div class="control-group">
                <label for="expiry-days">Expiration (jours)</label>
                <input type="number" id="expiry-days" value="7" min="1" max="365">
            </div>

            <button onclick="createShareLink()" class="btn btn-primary">Cr√©er un Lien de Partage</button>
            <div id="share-status" class="data-container" style="display: none;"></div>
        </section>

        <section class="card">
            <h2>üîê Tableaux de Bord Partag√©s Avec Vous</h2>
            <p>Consultez les tableaux de bord partag√©s avec vous</p>
            
            <div class="control-group">
                <button onclick="loadSharedDashboards()" class="btn btn-primary">Charger les Tableaux Partag√©s</button>
            </div>

            <div id="shared-dashboards-container" class="data-container">
                <div class="loading">Chargement des tableaux partag√©s...</div>
            </div>
        </section>
    </div>

    <!-- Tab: Alerts -->
    <div id="alerts-tab" class="tab-content">
        <section class="card">
            <div class="section-header">
                <h2>üîî Alertes Partag√©es avec l'√âquipe</h2>
                <button class="btn btn-primary" onclick="openAlertModal()">
                    ‚ûï Cr√©er une Alerte
                </button>
            </div>

            <div class="alerts-list" id="alertsList">
                <p class="loading">Chargement des alertes...</p>
            </div>
        </section>
    </div>

    <!-- Tab: Comments -->
    <div id="comments-tab" class="tab-content">
        <section class="card">
            <h2>üí¨ Commentaires et Annotations</h2>
            <div class="comments-section">
                <div class="form-group">
                    <label>S√©lectionner une Lecture</label>
                    <input type="number" id="readingIdSelect" placeholder="ID de la lecture">
                    <button class="btn btn-secondary" onclick="loadReadingComments()">
                        Charger
                    </button>
                </div>

                <div class="comments-container" id="commentsContainer">
                    <p class="text-muted">S√©lectionnez une lecture pour voir les commentaires</p>
                </div>

                <div class="add-comment-form">
                    <h3>Ajouter un Commentaire</h3>
                    <div class="form-group">
                        <textarea id="commentText" placeholder="√âcrivez votre commentaire..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addComment()">
                        üí¨ Poster Commentaire
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Tab: Activity -->
    <div id="activity-tab" class="tab-content">
        <section class="card">
            <h2>üìä Activit√© d'√âquipe</h2>
            <div class="activity-feed" id="activityFeed">
                <p class="loading">Chargement de l'activit√©...</p>
            </div>
        </section>

        <section class="card">
            <h2>üìà Statistiques d'√âquipe</h2>
            <div class="stats-grid" id="teamStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalShares">0</div>
                    <div class="stat-label">Partages Actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAlerts">0</div>
                    <div class="stat-label">Alertes Configur√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalComments">0</div>
                    <div class="stat-label">Commentaires</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="teamMembers">0</div>
                    <div class="stat-label">Membres d'√âquipe</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Tab: Teams -->
    <div id="teams-tab" class="tab-content">
        <section class="card">
            <h2>üë• Membres de l'√âquipe</h2>
            <p>G√©rez les membres de votre √©quipe et leurs acc√®s</p>
            
            <div class="control-group">
                <button onclick="loadTeamMembers()" class="btn btn-primary">Charger les Membres</button>
            </div>

            <div id="team-members-container" class="data-container">
                <div class="loading">Chargement des membres...</div>
            </div>
        </section>

        <section class="card">
            <h2>‚ûï Inviter un Membre</h2>
            
            <div class="control-group">
                <label for="invite-email">Email</label>
                <input type="email" id="invite-email" placeholder="colleague@example.com">
            </div>

            <div class="control-group">
                <label for="invite-role">R√¥le</label>
                <select id="invite-role">
                    <option value="viewer">Viewer</option>
                    <option value="editor">Editor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <button onclick="inviteTeamMember()" class="btn btn-primary">Envoyer l'Invitation</button>
            <div id="invite-status" class="data-container" style="display: none;"></div>
        </section>
    </div>
</div>

<!-- Modals -->
<div id="shareModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeShareModal()">&times;</span>
        <h2>Partager un Capteur</h2>
        <div class="form-group">
            <label>Capteur</label>
            <select id="modalSensorId"></select>
        </div>
        <div class="form-group">
            <label>Partager avec</label>
            <input type="email" id="modalShareEmail" placeholder="email@example.com">
        </div>
        <button class="btn btn-primary" onclick="createShare()">Partager</button>
    </div>
</div>

<div id="alertModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAlertModal()">&times;</span>
        <h2>Cr√©er une Alerte</h2>
        <div class="form-group">
            <label>Seuil CO‚ÇÇ</label>
            <input type="number" id="modalAlertThreshold" placeholder="1000">
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea id="modalAlertMessage" placeholder="Alerte CO‚ÇÇ √©lev√©"></textarea>
        </div>
        <button class="btn btn-primary" onclick="createAlert()">Cr√©er l'Alerte</button>
    </div>
</div>

<script>
function switchCollabTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.collaboration-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`[onclick="switchCollabTab('${tabName}')"]`).classList.add('active');
    
    // Load data for tab
    if (tabName === 'shares') loadShares();
    else if (tabName === 'alerts') loadAlerts();
    else if (tabName === 'activity') loadActivity();
    else if (tabName === 'teams') loadTeamMembers();
}

function loadShares() {
    fetch('/api/collaboration/shares')
        .then(r => r.json())
        .then(data => {
            const grid = document.getElementById('sharesGrid');
            if (data.success && data.shares.length > 0) {
                grid.innerHTML = data.shares.map(share => `
                    <div class="share-card">
                        <h3>${share.sensor_name}</h3>
                        <p>Partag√© avec: ${share.shared_with}</p>
                        <p>Cr√©√©: ${share.created_at}</p>
                        <button class="btn btn-danger" onclick="deleteShare(${share.id})">Supprimer</button>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p class="text-muted">Aucun partage actif</p>';
            }
        })
        .catch(() => {
            document.getElementById('sharesGrid').innerHTML = '<p class="error">Erreur de chargement</p>';
        });
}

function loadAlerts() {
    fetch('/api/collaboration/alerts')
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('alertsList');
            if (data.success && data.alerts.length > 0) {
                list.innerHTML = data.alerts.map(alert => `
                    <div class="alert-card">
                        <h3>üîî ${alert.message}</h3>
                        <p>Seuil: ${alert.threshold} ppm</p>
                        <p>Cr√©√©e: ${alert.created_at}</p>
                        <button class="btn btn-danger" onclick="deleteAlert(${alert.id})">Supprimer</button>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="text-muted">Aucune alerte configur√©e</p>';
            }
        });
}

function loadActivity() {
    fetch('/api/collaboration/activity')
        .then(r => r.json())
        .then(data => {
            const feed = document.getElementById('activityFeed');
            if (data.success) {
                feed.innerHTML = data.activity.map(item => `
                    <div class="activity-item">
                        <span class="activity-icon">${item.icon}</span>
                        <div>
                            <strong>${item.user}</strong> ${item.action}
                            <span class="activity-time">${item.time}</span>
                        </div>
                    </div>
                `).join('');
                
                // Update stats
                document.getElementById('totalShares').textContent = data.stats.shares;
                document.getElementById('totalAlerts').textContent = data.stats.alerts;
                document.getElementById('totalComments').textContent = data.stats.comments;
                document.getElementById('teamMembers').textContent = data.stats.members;
            }
        });
}

function loadTeamMembers() {
    fetch('/api/collaboration/team-members')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('team-members-container');
            if (data.success && data.members.length > 0) {
                container.innerHTML = `
                    <table class="team-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>R√¥le</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.members.map(member => `
                                <tr>
                                    <td>${member.name}</td>
                                    <td>${member.email}</td>
                                    <td>${member.role}</td>
                                    <td><span class="badge badge-${member.status}">${member.status}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="editMember(${member.id})">√âditer</button>
                                        <button class="btn btn-sm btn-danger" onclick="removeMember(${member.id})">Retirer</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = '<p class="text-muted">Aucun membre d\'√©quipe</p>';
            }
        });
}

function createShareLink() {
    const sensorId = document.getElementById('share-sensor-id').value;
    const expiry = document.getElementById('expiry-days').value;
    
    fetch('/api/collaboration/share-link', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sensor_id: sensorId, expiry_days: expiry})
    })
    .then(r => r.json())
    .then(data => {
        const status = document.getElementById('share-status');
        status.style.display = 'block';
        if (data.success) {
            status.innerHTML = `<div class="success">‚úÖ Lien cr√©√©: <a href="${data.share_link}" target="_blank">${data.share_link}</a></div>`;
        } else {
            status.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
        }
    });
}

function loadSharedDashboards() {
    const container = document.getElementById('shared-dashboards-container');
    fetch('/api/collaboration/shared-dashboards')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.dashboards.length > 0) {
                container.innerHTML = data.dashboards.map(dash => `
                    <div class="dashboard-card">
                        <h3>${dash.name}</h3>
                        <p>Partag√© par: ${dash.owner}</p>
                        <a href="${dash.url}" class="btn btn-primary">Ouvrir</a>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">Aucun tableau de bord partag√©</p>';
            }
        });
}

function inviteTeamMember() {
    const email = document.getElementById('invite-email').value;
    const role = document.getElementById('invite-role').value;
    
    fetch('/api/collaboration/invite', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, role})
    })
    .then(r => r.json())
    .then(data => {
        const status = document.getElementById('invite-status');
        status.style.display = 'block';
        if (data.success) {
            status.innerHTML = '<div class="success">‚úÖ Invitation envoy√©e</div>';
            document.getElementById('invite-email').value = '';
        } else {
            status.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
        }
    });
}

// Modal functions
function openShareModal() {
    document.getElementById('shareModal').style.display = 'block';
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
}

function openAlertModal() {
    document.getElementById('alertModal').style.display = 'block';
}

function closeAlertModal() {
    document.getElementById('alertModal').style.display = 'none';
}

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadShares();
});
</script>

<style>
.modal {
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
}

.modal-content {
    background: var(--card-bg);
    margin: 10% auto;
    padding: 30px;
    border-radius: 12px;
    max-width: 500px;
}

.close {
    float: right;
    font-size: 28px;
    cursor: pointer;
    color: #9ca3af;
}

.close:hover {
    color: #fff;
}
</style>

{% endblock %}
