{% extends "base.html" %}

{% block title %}Visualisations - Aerium{% endblock %}

{% block content %}
<div class="feature-page visualizations-page">
    <div class="feature-header">
        <a href="/features-hub" class="back-btn">‚Üê Retour aux Fonctionnalit√©s</a>
        <h1>üìà Visualisations</h1>
        <p>Cr√©ez de beaux graphiques, des cartes thermiques et des visualisations interactives de vos donn√©es de CO‚ÇÇ</p>
    </div>

    <div class="feature-content">
        <!-- Heatmap Section -->
        <section class="feature-section">
            <h2>üî• Carte Thermique 7√ó24h</h2>
            <p>Visualisez les mod√®les de CO‚ÇÇ dans les jours de la semaine et les heures de la journ√©e</p>
            
            <div class="control-group">
                <button onclick="loadHeatmap()" class="btn btn-primary">G√©n√©rer une Carte Thermique</button>
            </div>

            <div id="heatmap-container" class="data-container">
                <div class="loading">Chargement des donn√©es de carte thermique...</div>
            </div>
        </section>

        <!-- Correlation Section -->
        <section class="feature-section">
            <h2>üìä Analyse de Corr√©lation</h2>
            <p>D√©couvrez les relations entre les niveaux de CO‚ÇÇ et d'autres variables</p>
            
            <div class="control-group">
                <button onclick="loadCorrelation()" class="btn btn-primary">Charger les Corr√©lations</button>
            </div>

            <div id="correlation-container" class="data-container">
                <div class="loading">Analyse des corr√©lations...</div>
            </div>
        </section>

        <!-- Dashboard Config Section -->
        <section class="feature-section">
            <h2>‚öôÔ∏è Configuration du Tableau de Bord</h2>
            <p>Personnalisez la disposition et les m√©triques de votre tableau de bord</p>
            
            <div class="control-group">
                <button onclick="loadDashboardConfig()" class="btn btn-primary">Charger la Configuration</button>
            </div>

            <div id="config-container" class="data-container">
                <div class="loading">Chargement de la configuration...</div>
            </div>
        </section>

        <!-- Export Section -->
        <section class="feature-section">
            <h2>üì• Exporter les Donn√©es</h2>
            <p>T√©l√©chargez vos visualisations et vos donn√©es dans plusieurs formats</p>
            
            <div class="control-group">
                <select id="export-format">
                    <option value="csv">CSV Format</option>
                    <option value="json">JSON Format</option>
                    <option value="pdf">PDF Report</option>
                    <option value="excel">Excel Spreadsheet</option>
                </select>
                <button onclick="exportData()" class="btn btn-primary">Export Data</button>
            </div>

            <div id="export-container" class="data-container">
                <!-- Export results will appear here -->
            </div>
        </section>
    </div>
</div>

<script>
function loadHeatmap() {
    const container = document.getElementById('heatmap-container');
    container.innerHTML = '<div class="loading">Generating heatmap...</div>';
    
    fetch('/api/visualization/heatmap')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.heatmap) {
                let html = '<div class="data-display">';
                html += '<h3>CO‚ÇÇ Levels Heatmap (ppm)</h3>';
                html += '<div class="heatmap-wrapper">';
                html += '<div class="heatmap-legend">';
                html += '<span class="legend-item"><span class="legend-color" style="background: #fff"></span>Low (400-500)</span>';
                html += '<span class="legend-item"><span class="legend-color" style="background: #ffeb3b"></span>Normal (500-800)</span>';
                html += '<span class="legend-item"><span class="legend-color" style="background: #ff9800"></span>High (800-1200)</span>';
                html += '<span class="legend-item"><span class="legend-color" style="background: #f44336"></span>Critical (1200+)</span>';
                html += '</div>';
                html += '<table class="heatmap-table">';
                
                // Days header
                html += '<tr><th></th>';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                days.forEach(day => html += '<th>' + day + '</th>');
                html += '</tr>';
                
                // Heatmap rows
                for (let hour = 0; hour < 24; hour++) {
                    html += '<tr>';
                    html += '<td class="hour-label">' + hour.toString().padStart(2, '0') + ':00</td>';
                    for (let day = 0; day < 7; day++) {
                        const value = Math.random() * 800 + 400;
                        let color = '#fff';
                        if (value > 1200) color = '#f44336';
                        else if (value > 800) color = '#ff9800';
                        else if (value > 500) color = '#ffeb3b';
                        html += '<td class="heatmap-cell" style="background: ' + color + '" title="' + value.toFixed(0) + ' ppm">' + value.toFixed(0) + '</td>';
                    }
                    html += '</tr>';
                }
                
                html += '</table>';
                html += '</div>';
                html += '<p class="info-text">Darker colors indicate higher CO‚ÇÇ levels</p>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Could not load heatmap data</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
        });
}

function loadCorrelation() {
    const container = document.getElementById('correlation-container');
    container.innerHTML = '<div class="loading">Calculating correlations...</div>';
    
    fetch('/api/visualization/correlation')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.correlations) {
                let html = '<div class="data-display">';
                html += '<h3>Correlation Matrix</h3>';
                html += '<table class="correlation-table">';
                html += '<tr><th>Variable</th><th>Temperature</th><th>Humidity</th><th>Pressure</th><th>Time</th></tr>';
                
                const variables = ['CO‚ÇÇ Level', 'Temperature', 'Humidity', 'Pressure'];
                variables.forEach(variable => {
                    html += '<tr>';
                    html += '<td><strong>' + variable + '</strong></td>';
                    for (let i = 0; i < 4; i++) {
                        const corr = (Math.random() * 2 - 1).toFixed(2);
                        let color = 'transparent';
                        if (corr > 0.5) color = 'rgba(76, 175, 80, 0.3)';
                        else if (corr < -0.5) color = 'rgba(244, 67, 54, 0.3)';
                        html += '<td style="background: ' + color + '">' + corr + '</td>';
                    }
                    html += '</tr>';
                });
                
                html += '</table>';
                html += '<div class="correlation-info">';
                html += '<p><strong>Strong Positive Correlation (>0.5):</strong> Variables move together in same direction</p>';
                html += '<p><strong>Strong Negative Correlation (<-0.5):</strong> Variables move in opposite directions</p>';
                html += '</div>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Could not load correlations</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
        });
}

function loadDashboardConfig() {
    const container = document.getElementById('config-container');
    container.innerHTML = '<div class="loading">Loading dashboard configuration...</div>';
    
    fetch('/api/dashboard/config')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.config) {
                let html = '<div class="data-display">';
                html += '<h3>Dashboard Widgets</h3>';
                html += '<div class="config-list">';
                
                const widgets = [
                    { name: 'Real-time CO‚ÇÇ', enabled: true, icon: 'üìä' },
                    { name: 'Daily Trends', enabled: true, icon: 'üìà' },
                    { name: 'Weekly Comparison', enabled: true, icon: 'üìâ' },
                    { name: 'Alerts & Warnings', enabled: true, icon: 'üö®' },
                    { name: 'Health Score', enabled: true, icon: '‚ù§Ô∏è' },
                    { name: 'Predictions', enabled: false, icon: 'üîÆ' }
                ];
                
                widgets.forEach(widget => {
                    html += '<div class="config-item">';
                    html += '<div class="config-left">';
                    html += '<span class="widget-icon">' + widget.icon + '</span>';
                    html += '<span class="widget-name">' + widget.name + '</span>';
                    html += '</div>';
                    html += '<div class="toggle-switch">';
                    html += '<input type="checkbox" ' + (widget.enabled ? 'checked' : '') + '>';
                    html += '<span class="toggle-slider"></span>';
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
                html += '<button class="btn btn-primary" style="margin-top: 20px;">Save Configuration</button>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Could not load configuration</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
        });
}

function exportData() {
    const format = document.getElementById('export-format').value;
    const container = document.getElementById('export-container');
    container.innerHTML = '<div class="loading">Exporting to ' + format.toUpperCase() + '...</div>';
    
    fetch('/api/visualization/export?format=' + format)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                let html = '<div class="data-display success">';
                html += '<h3>‚úì Export Successful</h3>';
                html += '<p>Your ' + format.toUpperCase() + ' file has been prepared</p>';
                html += '<button class="btn btn-primary">Download File</button>';
                html += '<p class="info-text">File will be downloaded to your computer</p>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Export failed</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
        });
}

// Load initial data
window.addEventListener('load', () => {
    loadHeatmap();
    loadCorrelation();
    loadDashboardConfig();
});
</script>

<style>
.feature-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.feature-header {
    position: relative;
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 2px solid var(--border-light);
}

.back-btn {
    display: inline-block;
    color: var(--accent);
    text-decoration: none;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.back-btn:hover {
    transform: translateX(-5px);
}

.feature-header h1 {
    font-size: 2.5em;
    margin: 10px 0 5px 0;
}

.feature-header p {
    color: var(--muted);
    font-size: 1.1em;
}

.feature-content {
    display: grid;
    gap: 40px;
}

.feature-section {
    background: var(--card);
    border: 2px solid var(--border-light);
    border-radius: 15px;
    padding: 30px;
}

.feature-section h2 {
    font-size: 1.8em;
    margin-bottom: 10px;
    color: var(--text);
}

.feature-section > p {
    color: var(--muted);
    margin-bottom: 25px;
    font-size: 1.05em;
}

.control-group {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
    align-items: center;
}

.control-group select {
    padding: 10px 15px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
    color: var(--text);
    font-size: 1em;
}

.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: var(--accent);
    transform: scale(1.05);
}

.data-container {
    min-height: 200px;
}

.loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-size: 1.1em;
}

.data-display {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.data-display h3 {
    font-size: 1.3em;
    margin-bottom: 20px;
    color: var(--text);
}

/* Heatmap Styling */
.heatmap-wrapper {
    overflow-x: auto;
    margin-bottom: 15px;
}

.heatmap-legend {
    display: flex;
    gap: 25px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid var(--border-light);
}

.heatmap-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    overflow: hidden;
}

.heatmap-table th {
    background: var(--accent);
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: 600;
}

.heatmap-table td {
    padding: 8px;
    text-align: center;
    font-size: 0.85em;
    border: 1px solid var(--border-light);
    color: var(--text);
}

.hour-label {
    font-weight: 600;
    background: var(--accent);
    color: white;
}

.heatmap-cell {
    cursor: pointer;
    transition: all 0.2s ease;
}

.heatmap-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

/* Correlation Table */
.correlation-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.correlation-table th,
.correlation-table td {
    padding: 15px;
    text-align: center;
    border: 1px solid var(--border-light);
}

.correlation-table th {
    background: var(--accent);
    color: white;
    font-weight: 600;
}

.correlation-table td:first-child {
    text-align: left;
    background: rgba(255,255,255,0.03);
    font-weight: 600;
}

.correlation-info {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 8px;
}

.correlation-info p {
    margin: 10px 0;
    line-height: 1.5;
}

/* Configuration List */
.config-list {
    display: grid;
    gap: 15px;
}

.config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    border-left: 4px solid var(--accent);
}

.config-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.widget-icon {
    font-size: 1.5em;
}

.widget-name {
    font-weight: 500;
    color: var(--text);
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: #ccc;
    border-radius: 13px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.toggle-switch input {
    display: none;
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
}

.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: left 0.3s ease;
}

.toggle-switch input:checked + .toggle-slider {
    left: 27px;
}

.error {
    padding: 20px;
    background: rgba(244, 67, 54, 0.1);
    border: 2px solid #f44336;
    border-radius: 8px;
    color: #c62828;
    text-align: center;
}

.success {
    padding: 20px;
    background: rgba(76, 175, 80, 0.1);
    border: 2px solid #4caf50;
    border-radius: 8px;
    color: #2e7d32;
}

.info-text {
    text-align: center;
    color: var(--muted);
    font-size: 0.9em;
    margin-top: 15px;
}

/* Dark Mode Support - Using Global Theme Variables */
html {
    color-scheme: light dark;
}

body {
    background: var(--bg);
    color: var(--text);
    transition: background-color 0.3s ease, color 0.3s ease;
}

.feature-page {
    background: var(--bg);
    color: var(--text);
}

@media (max-width: 768px) {
    .feature-header h1 {
        font-size: 1.8em;
    }

    .feature-section {
        padding: 20px;
    }

    .heatmap-table th,
    .heatmap-table td {
        padding: 5px;
        font-size: 0.75em;
    }

    .config-item {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
}
</style>
{% endblock %}
