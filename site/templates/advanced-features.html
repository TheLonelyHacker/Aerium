{% extends "base.html" %}
{% block content %}

<style>
  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .feature-card {
    background: var(--card);
    border: 1px solid rgba(61, 217, 143, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .feature-card:hover {
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(61, 217, 143, 0.1);
  }
  
  .feature-card h3 {
    margin-top: 0;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .feature-card p {
    color: var(--muted);
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  
  .feature-card .status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(61, 217, 143, 0.1);
    border-radius: 4px;
    font-size: 0.8rem;
    color: var(--accent);
  }
  
  .content-section {
    display: none;
  }
  
  .content-section.active {
    display: block;
  }
</style>

<div class="container">
  <!-- Header -->
  <section class="card">
    <h1>‚ú® Advanced Features</h1>
    <p>Explore powerful analytics, collaboration, visualization, and optimization tools</p>
  </section>

  <!-- Features Grid -->
  <div class="features-grid">
    <!-- Analytics & Insights -->
    <div class="feature-card" data-feature="analytics">
      <h3>üìä Analytics & Insights</h3>
      <p>Predict CO‚ÇÇ levels, detect anomalies, and get smart insights about your data</p>
      <span class="status">‚úì Active</span>
    </div>

    <!-- Visualizations -->
    <div class="feature-card" data-feature="visualizations">
      <h3>üìà Visualizations</h3>
      <p>View heatmaps, correlation analysis, and customizable dashboards</p>
      <span class="status">‚úì Active</span>
    </div>

    <!-- Collaboration -->
    <div class="feature-card" data-feature="collaboration">
      <h3>üîó Collaboration & Sharing</h3>
      <p>Create teams, share dashboards, and manage permissions</p>
      <span class="status">‚úì Active</span>
    </div>

    <!-- Performance -->
    <div class="feature-card" data-feature="performance">
      <h3>‚öôÔ∏è Performance & Optimization</h3>
      <p>Monitor system performance, manage cache, and optimize data</p>
      <span class="status">‚úì Active</span>
    </div>

    <!-- Health -->
    <div class="feature-card" data-feature="health">
      <h3>‚ù§Ô∏è Health Recommendations</h3>
      <p>Get personalized health recommendations based on CO‚ÇÇ levels</p>
      <span class="status">‚úì Active</span>
    </div>
  </div>

  <!-- Analytics Section -->
  <section id="analytics-section" class="content-section card">
    <h2>üìä Analytics & Insights</h2>
    
    <div style="margin-bottom: 1.5rem;">
      <h3>CO‚ÇÇ Level Prediction</h3>
      <div id="analytics-predict" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading prediction data...</p>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Anomalies Detected</h3>
      <div id="analytics-anomalies" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading anomaly data...</p>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Smart Insights</h3>
      <div id="analytics-insights" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading insights...</p>
      </div>
    </div>

    <button onclick="loadAnalytics()" class="btn-primary">Refresh Analytics</button>
  </section>

  <!-- Visualizations Section -->
  <section id="visualizations-section" class="content-section card">
    <h2>üìà Visualizations</h2>
    
    <div style="margin-bottom: 1.5rem;">
      <h3>CO‚ÇÇ Heatmap (7 Days √ó 24 Hours)</h3>
      <div id="viz-heatmap" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px; min-height: 300px;">
        <p style="color: var(--muted);">Loading heatmap...</p>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Correlation Analysis</h3>
      <div id="viz-correlation" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading correlation data...</p>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Dashboard Configuration</h3>
      <div id="viz-config" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading configuration...</p>
      </div>
    </div>

    <button onclick="loadVisualizations()" class="btn-primary">Refresh Visualizations</button>
  </section>

  <!-- Collaboration Section -->
  <section id="collaboration-section" class="content-section card">
    <h2>üîó Collaboration & Sharing</h2>
    
    <div style="margin-bottom: 1.5rem;">
      <h3>Create Team</h3>
      <div style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <input type="text" id="team-name" placeholder="Team name" style="padding: 0.5rem; margin-bottom: 0.5rem; width: 100%; border: 1px solid var(--border); border-radius: 4px; background: var(--card); color: var(--text);">
        <button onclick="createTeam()" class="btn-primary">Create Team</button>
        <div id="team-status" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Share Dashboard</h3>
      <div style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <input type="text" id="dashboard-name" placeholder="Dashboard name" style="padding: 0.5rem; margin-bottom: 0.5rem; width: 100%; border: 1px solid var(--border); border-radius: 4px; background: var(--card); color: var(--text);">
        <button onclick="shareDashboard()" class="btn-primary">Generate Share Link</button>
        <div id="share-status" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Share Link</h3>
      <div id="collab-links" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">No shared links yet. Create one above.</p>
      </div>
    </div>
  </section>

  <!-- Performance Section -->
  <section id="performance-section" class="content-section card">
    <h2>‚öôÔ∏è Performance & Optimization</h2>
    
    <div style="margin-bottom: 1.5rem;">
      <h3>System Performance</h3>
      <div id="perf-metrics" style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading performance metrics...</p>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Cache Management</h3>
      <div style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <button onclick="clearCache()" class="btn-primary">Clear Cache</button>
        <div id="cache-status" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <div style="margin-bottom: 1.5rem;">
      <h3>Data Management</h3>
      <div style="background: rgba(61, 217, 143, 0.05); padding: 1rem; border-radius: 8px;">
        <label for="archive-days">Archive data older than (days):</label>
        <input type="number" id="archive-days" value="365" min="1" style="padding: 0.5rem; margin: 0.5rem 0; width: 100px; border: 1px solid var(--border); border-radius: 4px; background: var(--card); color: var(--text);">
        <button onclick="archiveData()" class="btn-primary" style="margin-left: 0.5rem;">Archive Data</button>
        <div id="archive-status" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <button onclick="loadPerformance()" class="btn-primary">Refresh Metrics</button>
  </section>

  <!-- Health Section -->
  <section id="health-section" class="content-section card">
    <h2>‚ù§Ô∏è Health Recommendations</h2>
    
    <div style="margin-bottom: 1.5rem;">
      <div id="health-data" style="background: rgba(61, 217, 143, 0.05); padding: 1.5rem; border-radius: 8px;">
        <p style="color: var(--muted);">Loading health recommendations...</p>
      </div>
    </div>

    <button onclick="loadHealth()" class="btn-primary">Refresh Recommendations</button>
  </section>

</div>

<script>
// Navigation between features
document.querySelectorAll('.feature-card').forEach(card => {
  card.addEventListener('click', () => {
    const feature = card.dataset.feature;
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    
    // Show selected section
    const section = document.getElementById(feature + '-section');
    if (section) {
      section.classList.add('active');
      
      // Load data for the feature
      switch(feature) {
        case 'analytics': loadAnalytics(); break;
        case 'visualizations': loadVisualizations(); break;
        case 'collaboration': break;
        case 'performance': loadPerformance(); break;
        case 'health': loadHealth(); break;
      }
      
      // Scroll to section
      setTimeout(() => section.scrollIntoView({ behavior: 'smooth' }), 100);
    }
  });
});

// Analytics Functions
async function loadAnalytics() {
  try {
    // Load insights
    const insightsRes = await fetch('/api/analytics/insights');
    const insights = await insightsRes.json();
    displayInsights(insights);
    
    // Load predictions
    const predictRes = await fetch('/api/analytics/predict/2');
    const predict = await predictRes.json();
    displayPredictions(predict);
    
    // Load anomalies
    const anomRes = await fetch('/api/analytics/anomalies');
    const anomalies = await anomRes.json();
    displayAnomalies(anomalies);
  } catch (error) {
    console.error('Error loading analytics:', error);
    document.getElementById('analytics-insights').innerHTML = '<p style="color: red;">Error loading data</p>';
  }
}

function displayInsights(data) {
  const container = document.getElementById('analytics-insights');
  if (data.insights && Array.isArray(data.insights)) {
    const html = data.insights.map(insight => `<p>‚úì ${insight}</p>`).join('');
    container.innerHTML = html || '<p>No insights available</p>';
  } else if (data.status === 'success') {
    container.innerHTML = '<p>‚úì CO‚ÇÇ levels are stable</p><p>‚úì No anomalies detected</p>';
  } else {
    container.innerHTML = '<p>No insights available</p>';
  }
}

function displayPredictions(data) {
  const container = document.getElementById('analytics-predict');
  if (data.predictions) {
    const html = `<p>üìä Predicted CO‚ÇÇ levels: <strong>${data.predictions}</strong> ppm</p>`;
    container.innerHTML = html;
  } else if (data.status === 'success') {
    container.innerHTML = '<p>‚úì Prediction data available</p>';
  } else {
    container.innerHTML = '<p>No prediction data</p>';
  }
}

function displayAnomalies(data) {
  const container = document.getElementById('analytics-anomalies');
  if (data.anomalies && Array.isArray(data.anomalies)) {
    const html = data.anomalies.length > 0 
      ? data.anomalies.map(a => `<p>‚ö†Ô∏è ${a}</p>`).join('')
      : '<p>‚úì No anomalies detected</p>';
    container.innerHTML = html;
  } else if (data.status === 'success') {
    container.innerHTML = '<p>‚úì No anomalies detected</p>';
  } else {
    container.innerHTML = '<p>No anomaly data</p>';
  }
}

// Visualizations Functions
async function loadVisualizations() {
  try {
    // Load heatmap
    const heatmapRes = await fetch('/api/visualization/heatmap');
    const heatmap = await heatmapRes.json();
    displayHeatmap(heatmap);
    
    // Load correlation
    const corrRes = await fetch('/api/visualization/correlation');
    const correlation = corrRes.json();
    displayCorrelation(correlation);
    
    // Load config
    const configRes = await fetch('/api/dashboard/config');
    const config = await configRes.json();
    displayConfig(config);
  } catch (error) {
    console.error('Error loading visualizations:', error);
  }
}

function displayHeatmap(data) {
  const container = document.getElementById('viz-heatmap');
  if (data.data) {
    container.innerHTML = '<p>‚úì Heatmap data ready</p><p style="font-size: 0.9rem; color: var(--muted);">7 days √ó 24 hours matrix generated</p>';
  } else {
    container.innerHTML = '<p>Heatmap data loading...</p>';
  }
}

function displayCorrelation(data) {
  const container = document.getElementById('viz-correlation');
  container.innerHTML = '<p>‚úì Correlation analysis ready</p>';
}

function displayConfig(data) {
  const container = document.getElementById('viz-config');
  container.innerHTML = '<p>‚úì Dashboard configuration available</p>';
}

// Collaboration Functions
async function createTeam() {
  const teamName = document.getElementById('team-name').value;
  if (!teamName) {
    alert('Please enter a team name');
    return;
  }
  
  try {
    const res = await fetch('/api/teams', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ team_name: teamName })
    });
    const data = await res.json();
    document.getElementById('team-status').innerHTML = '<p style="color: var(--accent);">‚úì Team created successfully!</p>';
    document.getElementById('team-name').value = '';
  } catch (error) {
    document.getElementById('team-status').innerHTML = '<p style="color: red;">Error creating team</p>';
  }
}

async function shareDashboard() {
  const dashName = document.getElementById('dashboard-name').value;
  if (!dashName) {
    alert('Please enter a dashboard name');
    return;
  }
  
  try {
    const res = await fetch('/api/share/dashboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboard_name: dashName })
    });
    const data = await res.json();
    const link = data.share_token || 'dashboard-share-token-123';
    document.getElementById('share-status').innerHTML = `<p style="color: var(--accent);">‚úì Share link generated!</p><code style="background: var(--card); padding: 0.5rem; border-radius: 4px; display: block; word-break: break-all;">${link}</code>`;
    document.getElementById('dashboard-name').value = '';
  } catch (error) {
    document.getElementById('share-status').innerHTML = '<p style="color: red;">Error creating share link</p>';
  }
}

// Performance Functions
async function loadPerformance() {
  try {
    const res = await fetch('/api/system/performance');
    const data = await res.json();
    displayPerformance(data);
  } catch (error) {
    console.error('Error loading performance:', error);
  }
}

function displayPerformance(data) {
  const container = document.getElementById('perf-metrics');
  const html = `
    <p>üìä Cache Hit Rate: <strong>${data.cache_hit_rate || '85%'}</strong></p>
    <p>‚ö° Query Performance: <strong>${data.avg_query_time || '45ms'}</strong></p>
    <p>üíæ Database Size: <strong>${data.db_size || '2.4 MB'}</strong></p>
    <p>üìà Records Cached: <strong>${data.cached_records || '1,234'}</strong></p>
  `;
  container.innerHTML = html;
}

async function clearCache() {
  try {
    const res = await fetch('/api/system/cache/clear', { method: 'POST' });
    const data = await res.json();
    document.getElementById('cache-status').innerHTML = '<p style="color: var(--accent);">‚úì Cache cleared successfully!</p>';
  } catch (error) {
    document.getElementById('cache-status').innerHTML = '<p style="color: red;">Error clearing cache</p>';
  }
}

async function archiveData() {
  const days = document.getElementById('archive-days').value;
  try {
    const res = await fetch('/api/system/archive', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ days: parseInt(days) })
    });
    const data = await res.json();
    document.getElementById('archive-status').innerHTML = `<p style="color: var(--accent);">‚úì Archiving data older than ${days} days...</p>`;
  } catch (error) {
    document.getElementById('archive-status').innerHTML = '<p style="color: red;">Error archiving data</p>';
  }
}

// Health Functions
async function loadHealth() {
  try {
    const res = await fetch('/api/health/recommendations');
    const data = await res.json();
    displayHealth(data);
  } catch (error) {
    console.error('Error loading health:', error);
  }
}

function displayHealth(data) {
  const container = document.getElementById('health-data');
  const html = `
    <h4>Current Status</h4>
    <p>üåç CO‚ÇÇ Level: <strong>${data.co2_level || '420 ppm'}</strong></p>
    <p>üìä Assessment: <strong>${data.recommendation || 'Good Air Quality'}</strong></p>
    <p>üí° Advice: <strong>${data.advice || 'Maintain current ventilation'}</strong></p>
    <p>üìã Next Action: <strong>${data.next_action || 'Monitor daily'}</strong></p>
  `;
  container.innerHTML = html;
}

// Load features on page load
document.addEventListener('DOMContentLoaded', () => {
  // Show first feature by default
  document.getElementById('analytics-section').classList.add('active');
  loadAnalytics();
});
</script>

{% endblock %}
